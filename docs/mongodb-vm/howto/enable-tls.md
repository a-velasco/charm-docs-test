# How to enable encryption 
This guide will show how to enable TLS using the [`self-signed-certificates` operator](https://github.com/canonical/self-signed-certificates-operator) as an example.

[note type="caution"]
**[Self-signed certificates](https://en.wikipedia.org/wiki/Self-signed_certificate) are not recommended for a production environment.**

Check [this guide](/t/11664) for an overview of the TLS certificates charms available. 
[/note]


## Summary
* [Enable and disable TLS in a replica set](#heading--tls-replica-set)
* [Enable and disable TLS in a sharded cluster](#heading--tls-sharded-cluster)
* [Rotate private keys](#heading--private-keys)
---
<a href="#heading--tls-replica-set"><h2 id="heading--tls-replica-set">Enable and disable TLS in a replica set</h2></a>
### Enable TLS
Deploy the TLS charm:
```shell
juju deploy self-signed-certificates
```
To enable TLS, integrate (formerly known as “relate”) the two applications:
```shell
juju integrate self-signed-certificates mongodb
```
Your replica set now has encryption enabled via TLS.

### Disable TLS
To disable TLS, just remove the integration:
```shell
juju remove-relation mongodb self-signed-certificates
```
<a href="#heading--tls-sharded-cluster"><h2 id="heading--tls-rsharded-cluster">Enable and disable TLS in a sharded cluster</h2></a>

Enabling encryption via TLS in a sharded cluster can be done before or after shards are added to the config-server.

However, it requires that:

1. All cluster components have encryption enabled
2. All cluster components are integrated to the **same** Certificate Authority.

### Enable TLS
Deploy the TLS charm:

```shell
juju deploy self-signed-certificates --config ca-common-name="Example CA"
```

Integrate your Certificate Authority into all cluster components. In a cluster with two shards and a config-server this would be done as follows:
```shell
juju integrate config-server self-signed-certificates
juju integrate shard-one self-signed-certificates
juju integrate shard-two self-signed-certificates
```
Your sharded cluster now has encryption enabled via TLS.

### Disable TLS
To disable TLS, just remove the integrations:
```shell
juju remove-relation config-server self-signed-certificates
juju remove-relation shard-one self-signed-certificates
juju remove-relation shard-two self-signed-certificates
```
<a href="#heading--private-keys"><h2 id="heading--private-keys">Rotate private keys</h2></a>

Updates to internal and external private keys for certificate signing requests (CSR) can be made via the `set-tls-private-key` action. To update all keys, you must run the`set-tls-private-key` action on all charmed MongoDB units in your replica set or sharded cluster. 

### Rotate with a manually generated key

To rotate the your private keys, first generate your keys:
```shell
openssl genrsa -out internal-key.pem 3072
openssl genrsa -out external-key.pem 3072
```
Then, apply the new external key to the leader of your replica set or config-server. 
[note type="caution"]
**Note:** Passing keys to juju should only be done with `base64 -w0`, not `cat`.
[/note]

```shell
juju run <application-name>/leader set-tls-private-key \
"internal-key=$(base64 -w0 internal-key.pem)"  "external-key=$(base64 -w0 external-key-0.pem)"  
```

### Rotate with an autogenerated key

The keys can be auto-generated and set as follows:

```shell
juju run <application-name>/leader set-tls-private-key
```